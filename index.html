<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>De quelle couleur seront mes chatons ? — Trycoline’s</title>

<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Fredoka:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  :root{
    --page-bg:#ffffff;      /* fond page */
    --frame-bg:#FAF3F7;     /* fond du cadre englobant (rosé très doux) */
    --frame-border:#D6B3E0; /* lilac pastel pour la bordure du cadre */
    --panel:#ffffff;        /* cartes internes (panneaux) */
    --border:#e9defc;       /* lilac clair pour petites bordures internes */
    --accent:#6b4ea3;       /* lilac soutenu */
    --accent-2:#d37fb2;     /* rose accent */
    --ink:#26233a;
    --muted:#6b6a75;
    --ok:#167f5d; --warn:#a56a00; --err:#7a2a2a;
  }

  /* Base */
  html,body{margin:0;padding:0;background:var(--page-bg);color:var(--ink)}
  body{font-family:"Fredoka",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; line-height:1.65}

  /* Cadre englobant TOUT (large + aéré) */
  .frame{
    max-width:1024px;
    margin:24px auto;
    background:var(--frame-bg);
    border:2px solid var(--frame-border);
    border-radius:16px;
    padding:22px;
  }

  .wrap{max-width:980px;margin:0 auto}

  h1{font-family:"Dancing Script",cursive; font-size:2.4rem; margin:0 0 8px; color:var(--accent)}
  .subtitle{margin:0 0 20px; color:#87518a}

  /* Panneaux Père & Mère */
  .panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:18px;
    padding:18px;
    margin:16px 0;
  }
  .panel h2{font-size:1.2rem; margin:0 0 12px; color:var(--accent-2)}

  .group{margin:16px 0}
  .group label.block{display:block; font-weight:600; margin-bottom:8px}
  .checks{display:flex; flex-wrap:wrap; gap:10px}
  .checks label{display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer}
  select{font:inherit; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-width:220px; background:#fff}
  .hint{font-size:.92rem; color:var(--muted); margin-top:6px}
  .divider{height:1px; background:var(--border); margin:18px 0}

  /* Ligne des gènes (3 blocs côte à côte) */
  .genes-row{
    display:grid;
    grid-template-columns:repeat(3, minmax(220px,1fr));
    gap:14px;
  }
  .gene{
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    background:#fff;
  }
  .gene .gene-title{
    font-weight:600; margin-bottom:8px; color:#5f4799; font-size:0.98rem
  }

  /* Actions */
  .actions{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 4px}
  .btn{border:1px solid var(--accent); background:var(--accent); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn.secondary{background:#fff; color:var(--accent)}
  .btn.ghost{background:#fff; color:#5a3b47; border-color:#eec6dc}

  /* Résultats */
  .out{background:#fff; border:1px solid var(--border); border-radius:18px; padding:18px; margin:16px 0}
  .section{margin:10px 0 14px}
  .section h3{font-family:"Dancing Script",cursive; font-size:1.4rem; color:var(--accent); margin:6px 0}
  .tags{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
  .tag{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:.95rem}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .muted{color:var(--muted)}

  /* Erreur & Impression */
  .error{padding:10px 12px; border:1px solid #f2c4c4; background:#fff0f0; color:var(--err); border-radius:12px; display:none; margin:10px 0}
  @media print{
    .no-print{display:none !important}
    body{background:#fff}
    .frame{border-color:#ccc; background:#fff}
  }

  /* Responsive */
  @media (max-width: 960px){
    .genes-row{grid-template-columns:repeat(2, minmax(200px,1fr))}
  }
  @media (max-width: 640px){
    .genes-row{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="frame">
  <div class="wrap">
    <h1>De quelle couleur seront mes chatons ?</h1>
    <p class="subtitle">Calculette génétique — patrons, couleurs, tabby, récessifs et gène roux (explicite).</p>

    <!-- ===== 1) PÈRE ===== -->
    <div class="panel" id="pere">
      <h2>Père</h2>

      <div class="group">
        <label class="block">Patron (choix unique)</label>
        <div class="checks" data-one="pa_motif">
          <label><input type="checkbox" name="pa_motif" value="colourpoint"> Colourpoint</label>
          <label><input type="checkbox" name="pa_motif" value="mitted"> Mitted</label>
          <label><input type="checkbox" name="pa_motif" value="high_mitted"> High Mitted</label>
          <label><input type="checkbox" name="pa_motif" value="bicolore"> Bicolore</label>
          <label><input type="checkbox" name="pa_motif" value="mid_high_white"> Mid High White</label>
          <label><input type="checkbox" name="pa_motif" value="van_high_white"> Van / High White</label>
        </div>
      </div>

      <div class="group">
        <label for="pa_tabby" class="block">Tabby (lynx)</label>
        <select id="pa_tabby">
          <option value="non" selected>Non</option>
          <option value="oui">Oui</option>
          <option value="oui_porteur_non_tabby">Oui porteur non tabby</option>
        </select>
      </div>

      <div class="divider"></div>

      <!-- Gènes sur UNE ligne -->
      <div class="genes-row">
        <div class="gene">
          <div class="gene-title">Chocolat (B/b)</div>
          <div class="checks">
            <label><input type="checkbox" class="x-lock pa-choco-expr"> Exprimé (bb)</label>
            <label><input type="checkbox" class="x-lock-oppo pa-choco-port"> Porteur (B b)</label>
          </div>
        </div>
        <div class="gene">
          <div class="gene-title">Cinnamon (B/bl)</div>
          <div class="checks">
            <label><input type="checkbox" class="x-lock pa-cinn-expr"> Exprimé (bl bl)</label>
            <label><input type="checkbox" class="x-lock-oppo pa-cinn-port"> Porteur (B bl)</label>
          </div>
        </div>
        <div class="gene">
          <div class="gene-title">Dilution (D/d)</div>
          <div class="checks">
            <label><input type="checkbox" class="x-lock pa-dil-expr"> Exprimée (dd)</label>
            <label><input type="checkbox" class="x-lock-oppo pa-dil-port"> Porteur (Dd)</label>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="group">
        <label for="pa_roux" class="block">Roux / Crème (gène O, lié au sexe)</label>
        <select id="pa_roux">
          <option value="non" selected>Non roux (oY)</option>
          <option value="oui">Roux / Crème (OY)</option>
        </select>
        <div class="hint">Mâle : O = roux/crème. <strong>Pas</strong> de porteur.</div>
      </div>
    </div>

    <!-- ===== 2) MÈRE ===== -->
    <div class="panel" id="mere">
      <h2>Mère</h2>

      <div class="group">
        <label class="block">Patron (choix unique)</label>
        <div class="checks" data-one="pb_motif">
          <label><input type="checkbox" name="pb_motif" value="colourpoint"> Colourpoint</label>
          <label><input type="checkbox" name="pb_motif" value="mitted"> Mitted</label>
          <label><input type="checkbox" name="pb_motif" value="high_mitted"> High Mitted</label>
          <label><input type="checkbox" name="pb_motif" value="bicolore"> Bicolore</label>
          <label><input type="checkbox" name="pb_motif" value="mid_high_white"> Mid High White</label>
          <label><input type="checkbox" name="pb_motif" value="van_high_white"> Van / High White</label>
        </div>
      </div>

      <div class="group">
        <label for="pb_tabby" class="block">Tabby (lynx)</label>
        <select id="pb_tabby">
          <option value="non" selected>Non</option>
          <option value="oui">Oui</option>
          <option value="oui_porteur_non_tabby">Oui porteur non tabby</option>
        </select>
      </div>

      <div class="divider"></div>

      <!-- Gènes sur UNE ligne -->
      <div class="genes-row">
        <div class="gene">
          <div class="gene-title">Chocolat (B/b)</div>
          <div class="checks">
            <label><input type="checkbox" class="x-lock pb-choco-expr"> Exprimé (bb)</label>
            <label><input type="checkbox" class="x-lock-oppo pb-choco-port"> Porteuse (B b)</label>
          </div>
        </div>
        <div class="gene">
          <div class="gene-title">Cinnamon (B/bl)</div>
          <div class="checks">
            <label><input type="checkbox" class="x-lock pb-cinn-expr"> Exprimé (bl bl)</label>
            <label><input type="checkbox" class="x-lock-oppo pb-cinn-port"> Porteuse (B bl)</label>
          </div>
        </div>
        <div class="gene">
          <div class="gene-title">Dilution (D/d)</div>
          <div class="checks">
            <label><input type="checkbox" class="x-lock pb-dil-expr"> Exprimée (dd)</label>
            <label><input type="checkbox" class="x-lock-oppo pb-dil-port"> Porteuse (Dd)</label>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="group">
        <label for="pb_roux" class="block">Roux / Tortie (gène O, lié au sexe)</label>
        <select id="pb_roux">
          <option value="oo" selected>Non rousse (oo)</option>
          <option value="Oo">Tortie (Oo)</option>
          <option value="OO">Rousse (OO)</option>
        </select>
        <div class="hint">Femelle : OO = rousse ; Oo = tortie ; oo = non rousse.</div>
      </div>
    </div>

    <!-- ===== Actions ===== -->
    <div class="actions no-print">
      <button class="btn" id="btn_calc">Prédire</button>
      <button class="btn secondary" id="btn_reset" type="button">Réinitialiser</button>
      <button class="btn ghost" id="btn_print" type="button">Imprimer</button>
    </div>
    <div id="formError" class="error"></div>

    <!-- ===== 3) RÉSULTATS ===== -->
    <div class="out" id="result">
      <div class="section" id="r_patron"><h3>Patrons</h3><div class="tags" id="motif"></div></div>
      <div class="section" id="r_couleurs"><h3>Couleurs de base</h3><div class="tags" id="basecolors"></div></div>
      <div class="section" id="r_tabby"><h3>Tabby</h3><div class="tags" id="tabby"></div></div>
      <div class="section" id="r_recessifs"><h3>Récessifs (infos élevage)</h3><div class="tags" id="recessifs"></div></div>
      <div class="section" id="r_roux"><h3>Roux / Tortie (répartition M/F)</h3><div class="tags" id="roux"></div></div>
    </div>
  </div>
</div>

<script>
/* ==== UI helpers ==== */
function enforceSingleCheckbox(groupAttr){
  const box = document.querySelector('.checks[data-one="'+groupAttr+'"]');
  if(!box) return;
  box.addEventListener('change',(e)=>{
    if(e.target.type==='checkbox' && e.target.checked){
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb!==e.target) cb.checked=false; });
    }
  });
}
enforceSingleCheckbox('pa_motif');
enforceSingleCheckbox('pb_motif');

function setupMutualLock(){
  const pairs = [
    ['pa-choco-expr','pa-choco-port'],['pa-cinn-expr','pa-cinn-port'],['pa-dil-expr','pa-dil-port'],
    ['pb-choco-expr','pb-choco-port'],['pb-cinn-expr','pb-cinn-port'],['pb-dil-expr','pb-dil-port'],
  ];
  pairs.forEach(([a,b])=>{
    const A=document.querySelector('.'+a), B=document.querySelector('.'+b);
    if(A&&B){ A.addEventListener('change',()=>{ if(A.checked) B.checked=false; }); B.addEventListener('change',()=>{ if(B.checked) A.checked=false; }); }
  });
  // éviter choco+cinna simultanément en "porteur"
  [['pa-choco-port','pa-cinn-port'],['pb-choco-port','pb-cinn-port']].forEach(([c1,c2])=>{
    const C1=document.querySelector('.'+c1), C2=document.querySelector('.'+c2);
    if(C1&&C2){ C1.addEventListener('change',()=>{ if(C1.checked) C2.checked=false; }); C2.addEventListener('change',()=>{ if(C2.checked) C1.checked=false; }); }
  });
}
setupMutualLock();

function readMotif(name){
  const boxes=[...document.querySelectorAll('input[name="'+name+'"]')];
  const sel=boxes.find(cb=>cb.checked);
  return sel?sel.value:null;
}
function renderTags(id, items){
  const el=document.getElementById(id);
  el.innerHTML = items && items.length ? items.map(x=>`<span class="tag ${x.cls||''}">${x.txt}</span>`).join('') : '<span class="tag muted">—</span>';
}
function requireMotifs(){
  const pa=readMotif('pa_motif'), pb=readMotif('pb_motif');
  const err=document.getElementById('formError');
  if(!pa||!pb){ err.textContent='Erreur : sélectionne un patron pour chaque parent.'; err.style.display='block'; return null; }
  err.style.display='none'; return {pa,pb};
}

/* ==== Patrons (sans fallback) ==== */
const P={COLOURPOINT:'colourpoint', MITTED:'mitted', HIGH_MITTED:'high_mitted', BICOLORE:'bicolore', MID_HIGH_WHITE:'mid_high_white', VAN:'van_high_white'};
const motifRuleMap={
  [`${P.COLOURPOINT}|${P.COLOURPOINT}`]: {'Colourpoint':100},
  [`${P.COLOURPOINT}|${P.MITTED}`]: {'Mitted':50,'Colourpoint':50},
  [`${P.COLOURPOINT}|${P.HIGH_MITTED}`]: {'Mitted':100},
  [`${P.COLOURPOINT}|${P.BICOLORE}`]: {'Colourpoint':50,'Bicolore':50},
  [`${P.COLOURPOINT}|${P.MID_HIGH_WHITE}`]: {'Bicolore':50,'Mitted':50},
  [`${P.COLOURPOINT}|${P.VAN}`]: {'Bicolore':100},

  [`${P.MITTED}|${P.COLOURPOINT}`]: {'Colourpoint':50,'Mitted':50},
  [`${P.MITTED}|${P.MITTED}`]: {'Mitted':50,'Colourpoint':25,'High Mitted':25},
  [`${P.MITTED}|${P.HIGH_MITTED}`]: {'Mitted':50,'High Mitted':50},
  [`${P.MITTED}|${P.BICOLORE}`]: {'Colourpoint':25,'Mitted':25,'Bicolore':25,'Mid High White':25},
  [`${P.MITTED}|${P.MID_HIGH_WHITE}`]: {'Mitted':25,'Bicolore':25,'High Mitted':25,'Mid High White':25},
  [`${P.MITTED}|${P.VAN}`]: {'Bicolore':50,'Mid High White':50},

  [`${P.HIGH_MITTED}|${P.COLOURPOINT}`]: {'Mitted':100},
  [`${P.HIGH_MITTED}|${P.MITTED}`]: {'Mitted':50,'High Mitted':50},
  [`${P.HIGH_MITTED}|${P.HIGH_MITTED}`]: {'High Mitted':100},
  [`${P.HIGH_MITTED}|${P.BICOLORE}`]: {'Mitted':50,'Mid High White':50},
  [`${P.HIGH_MITTED}|${P.MID_HIGH_WHITE}`]: {'High Mitted':50,'Mid High White':50},
  [`${P.HIGH_MITTED}|${P.VAN}`]: {'Mid High White':100},

  [`${P.BICOLORE}|${P.COLOURPOINT}`]: {'Colourpoint':50,'Bicolore':50},
  [`${P.BICOLORE}|${P.MITTED}`]: {'Colourpoint':25,'Mitted':25,'Bicolore':25,'Mid High White':25},
  [`${P.BICOLORE}|${P.HIGH_MITTED}`]: {'Mitted':50,'Mid High White':50},
  [`${P.BICOLORE}|${P.BICOLORE}`]: {'Colourpoint':25,'Bicolore':50,'Van/High White':25},
  [`${P.BICOLORE}|${P.MID_HIGH_WHITE}`]: {'Mitted':25,'Bicolore':25,'High Mitted':25,'Van/High White':25},
  [`${P.BICOLORE}|${P.VAN}`]: {'Bicolore':50,'Van/High White':50},

  [`${P.MID_HIGH_WHITE}|${P.COLOURPOINT}`]: {'Bicolore':50,'Mitted':50},
  [`${P.MID_HIGH_WHITE}|${P.MITTED}`]: {'Mitted':25,'Bicolore':25,'High Mitted':25,'Mid High White':25},
  [`${P.MID_HIGH_WHITE}|${P.HIGH_MITTED}`]: {'High Mitted':50,'Mid High White':50},
  [`${P.MID_HIGH_WHITE}|${P.BICOLORE}`]: {'Mitted':25,'Bicolore':25,'High Mitted':25,'Van/High White':25},
  [`${P.MID_HIGH_WHITE}|${P.MID_HIGH_WHITE}`]: {'High Mitted':50,'Mid High White':50},
  [`${P.MID_HIGH_WHITE}|${P.VAN}`]: {'Mid High White':50,'Van/High White':50},

  [`${P.VAN}|${P.COLOURPOINT}`]: {'Bicolore':100},
  [`${P.VAN}|${P.MITTED}`]: {'Mitted':50,'Mid High White':50},
  [`${P.VAN}|${P.HIGH_MITTED}`]: {'Mid High White':100},
  [`${P.VAN}|${P.BICOLORE}`]: {'Bicolore':50,'Van/High White':50},
  [`${P.VAN}|${P.MID_HIGH_WHITE}`]: {'Mid High White':50,'Van/High White':50},
  [`${P.VAN}|${P.VAN}`]: {'Van/High White':100}
};
function computeMotif(pa,pb){
  const key=`${pa}|${pb}`, alt=`${pb}|${pa}`;
  const dist=motifRuleMap[key]||motifRuleMap[alt];
  return dist?dist:null;
}

/* ==== Couleurs (B/b/bl + D/d) ==== */
function parentBGenotype(prefix){
  const ch_expr=document.querySelector('.'+prefix+'-choco-expr').checked;
  const ch_port=document.querySelector('.'+prefix+'-choco-port').checked;
  const ci_expr=document.querySelector('.'+prefix+'-cinn-expr').checked;
  const ci_port=document.querySelector('.'+prefix+'-cinn-port').checked;
  if(ch_expr) return ['b','b'];
  if(ci_expr) return ['bl','bl'];
  if(ch_port) return ['B','b'];
  if(ci_port) return ['B','bl'];
  return ['B','B'];
}
function parentDGenotype(prefix){
  const d_expr=document.querySelector('.'+prefix+'-dil-expr').checked;
  const d_port=document.querySelector('.'+prefix+'-dil-port').checked;
  if(d_expr) return ['d','d'];
  if(d_port) return ['D','d'];
  return ['D','D'];
}
function gametes(a1,a2){ return a1===a2?[[a1,1]]:[[a1,.5],[a2,.5]]; }
function cross(gA,gB){
  const m=new Map();
  gA.forEach(([a,pA])=>gB.forEach(([b,pB])=>{
    const pair=[a,b].sort().join('/'); m.set(pair,(m.get(pair)||0)+pA*pB);
  }));
  return [...m.entries()].map(([pair,p])=>[[...pair.split('/')],p]);
}
function phenotypeB(alleles){
  const set=new Set(alleles);
  if(set.has('B')) return 'Seal';
  if(set.has('b') && set.has('bl')) return 'Chocolat';
  if(alleles[0]==='b' && alleles[1]==='b') return 'Chocolat';
  return 'Cinnamon';
}
function applyDilution(base,d){
  const dd=(d[0]==='d' && d[1]==='d');
  if(!dd) return base;
  if(base==='Seal') return 'Blue';
  if(base==='Chocolat') return 'Lilac';
  if(base==='Cinnamon') return 'Fawn';
  return base;
}
function computeBaseColors(){
  const bA=parentBGenotype('pa'), bB=parentBGenotype('pb');
  const dA=parentDGenotype('pa'), dB=parentDGenotype('pb');
  const kidsB=cross(gametes(bA[0],bA[1]), gametes(bB[0],bB[1]));
  const kidsD=cross(gametes(dA[0],dA[1]), gametes(dB[0],dB[1]));
  const tally=new Map();
  kidsB.forEach(([b,pB])=>kidsD.forEach(([d,pD])=>{
    const base=phenotypeB(b); const col=applyDilution(base,d);
    tally.set(col,(tally.get(col)||0)+pB*pD);
  }));
  return [...tally.entries()].map(([c,p])=>({color:c,prob:Math.round(p*1000)/10})).sort((a,b)=>b.prob-a.prob);
}

/* ==== Tabby ==== */
function computeTabby(paTabby,pbTabby){
  const geno=(v)=>v==='non'?'aa':(v==='oui'?'TT':'Ta');
  const gA=geno(paTabby), gB=geno(pbTabby), out=[];
  if(gA==='aa'&&gB==='aa') out.push({txt:'100% non tabby.',cls:'muted'});
  else if((gA==='TT'&&gB==='aa')||(gA==='aa'&&gB==='TT')) out.push({txt:'100% tabby.',cls:'ok'});
  else if((gA==='Ta'&&gB==='aa')||(gA==='aa'&&gB==='Ta')) out.push({txt:'≈ 50% tabby / 50% non tabby.',cls:''});
  else if((gA==='TT'&&gB==='Ta')||(gA==='Ta'&&gB==='TT')) out.push({txt:'100% tabby (au moins hétérozygotes).',cls:'ok'});
  else if(gA==='TT'&&gB==='TT') out.push({txt:'100% tabby (homozygotes).',cls:'ok'});
  else if(gA==='Ta'&&gB==='Ta') out.push({txt:'≈ 75% tabby / 25% non tabby.',cls:''});
  return out;
}

/* ==== Récessifs (affichage) ==== */
function locusOutcome(Aexpr,Aport,Bexpr,Bport,nom){
  Aport=!Aexpr&&Aport; Bport=!Bexpr&&Bport;
  const lines=[];
  if(Aexpr&&Bexpr) lines.push({txt:`${nom}: 100% exprimé (tous transmetteurs certains).`,cls:'ok'});
  else if((Aexpr&&Bport)||(Bexpr&&Aport)) lines.push({txt:`${nom}: ≈ 50% exprimé / 50% porteur.`,cls:''});
  else if(Aexpr&&!Bexpr&&!Bport) lines.push({txt:`${nom}: 100% porteurs (parent exprimé = transmetteur certain).`,cls:'ok'});
  else if(Bexpr&&!Aexpr&&!Aport) lines.push({txt:`${nom}: 100% porteurs (parent exprimé = transmetteur certain).`,cls:'ok'});
  else if(Aport&&Bport) lines.push({txt:`${nom}: ≈ 25% exprimé / 50% porteur / 25% non porteur.`,cls:''});
  else if((Aport&&!Bexpr&&!Bport)||(Bport&&!Aexpr&&!Aport)) lines.push({txt:`${nom}: ≈ 50% porteur / 50% non porteur.`,cls:''});
  else lines.push({txt:`${nom}: Non transmis.`,cls:'muted'});
  return lines;
}

/* ==== Roux/Tortie — répartition claire M/F ==== */
function computeRouxExplicit(maleRoux, femState){
  let males='', females='';
  if(maleRoux==='oui' && femState==='oo'){ males='0% roux / 100% non roux'; females='100% torties'; }
  else if(maleRoux==='oui' && femState==='Oo'){ males='50% roux / 50% non roux'; females='50% rousses / 50% torties'; }
  else if(maleRoux==='oui' && femState==='OO'){ males='100% roux'; females='100% rousses'; }
  else if(maleRoux==='non' && femState==='oo'){ males='0% roux'; females='0% rousses/torties'; }
  else if(maleRoux==='non' && femState==='Oo'){ males='50% roux / 50% non roux'; females='50% torties / 50% non rousses'; }
  else if(maleRoux==='non' && femState==='OO'){ males='100% roux'; females='100% torties'; }
  return [{txt:`Mâles : ${males}`},{txt:`Femelles : ${femelles}`}];
}

/* ==== Calcul global ==== */
function onCalculate(){
  const sel=requireMotifs(); if(!sel) return;

  // Patrons
  const dist=computeMotif(sel.pa, sel.pb);
  const motifItems = dist ? Object.entries(dist).map(([k,v])=>({txt:`${k}: ${v}%`})) : [{txt:'Combinaison non définie.',cls:'warn'}];
  renderTags('motif', motifItems);

  // Couleurs
  const colors=computeBaseColors();
  renderTags('basecolors', colors.length ? colors.map(c=>({txt:`${c.color}: ${c.prob}%`})) : [{txt:'—',cls:'muted'}]);

  // Tabby
  renderTags('tabby', computeTabby(
    document.getElementById('pa_tabby').value,
    document.getElementById('pb_tabby').value
  ));

  // Récessifs (pédagogie)
  let rec=[];
  locusOutcome(
    document.querySelector('.pa-choco-expr').checked,
    document.querySelector('.pa-choco-port').checked,
    document.querySelector('.pb-choco-expr').checked,
    document.querySelector('.pb-choco-port').checked,'Chocolat'
  ).forEach(x=>rec.push(x));
  locusOutcome(
    document.querySelector('.pa-cinn-expr').checked,
    document.querySelector('.pa-cinn-port').checked,
    document.querySelector('.pb-cinn-expr').checked,
    document.querySelector('.pb-cinn-port').checked,'Cinnamon'
  ).forEach(x=>rec.push(x));
  locusOutcome(
    document.querySelector('.pa-dil-expr').checked,
    document.querySelector('.pa-dil-port').checked,
    document.querySelector('.pb-dil-expr').checked,
    document.querySelector('.pb-dil-port').checked,'Dilution'
  ).forEach(x=>rec.push(x));
  renderTags('recessifs', rec);

  // Roux (M/F)
  const rouxItems = computeRouxExplicit(
    document.getElementById('pa_roux').value,
    document.getElementById('pb_roux').value
  );
  renderTags('roux', rouxItems);
}

/* Boutons */
document.getElementById('btn_calc').addEventListener('click', onCalculate);
document.getElementById('btn_reset').addEventListener('click', ()=>{
  document.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
  document.getElementById('pa_tabby').value='non'; document.getElementById('pb_tabby').value='non';
  document.getElementById('pa_roux').value='non'; document.getElementById('pb_roux').value='oo';
  ['motif','basecolors','tabby','recessifs','roux'].forEach(id=>document.getElementById(id).innerHTML='');
  document.getElementById('formError').style.display='none';
});
document.getElementById('btn_print').addEventListener('click', ()=>window.print());

/* Validation patrons obligatoires */
function requireMotifs(){
  const pa=readMotif('pa_motif'), pb=readMotif('pb_motif');
  const err=document.getElementById('formError');
  if(!pa||!pb){ err.textContent='Erreur : sélectionne un patron pour chaque parent.'; err.style.display='block'; return null; }
  err.style.display='none'; return {pa,pb};
}
</script>
</body>
</html>
