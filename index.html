<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>De quelle couleur seront mes chatons ? — Trycoline’s</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Fredoka:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --page-bg:#ffffff;
    --frame-bg:#FAF3F7;      /* rose très doux */
    --frame-border:#D6B3E0;  /* lilac pastel */
    --panel:#ffffff;
    --border:#e9defc;        /* lilac clair interne */
    --accent:#6b4ea3;        /* lilac soutenu */
    --accent-2:#d37fb2;      /* rose accent */
    --ink:#26233a; --muted:#6b6a75;
    --radius:14px;
  }
  html,body{margin:0;padding:0;background:var(--page-bg);color:var(--ink)}
  body{font-family:"Fredoka",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; line-height:1.5; font-size:15px}
  /* Cadre général (tout entouré) */
  .frame{max-width:980px; margin:18px auto; background:var(--frame-bg);
    border:2px solid var(--frame-border); border-radius:16px; padding:14px;}
  .wrap{max-width:940px; margin:0 auto}
  h1{font-family:"Dancing Script",cursive; font-size:2.1rem; margin:0 0 4px; color:var(--accent)}
  .subtitle{margin:0 0 12px; color:#87518a; font-size:0.98rem}

  .panel{background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); padding:12px; margin:10px 0;}
  .panel h2{font-size:1.05rem; margin:0 0 8px; color:var(--accent-2)}

  .row{display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap}
  .col{flex:1 1 320px; min-width:260px}
  .group{margin:8px 0}
  .group label.block{display:block; font-weight:600; margin-bottom:4px; font-size:0.95rem}
  select{font:inherit; border:1px solid var(--border); border-radius:10px; padding:8px 10px; min-width:220px; background:#fff}
  .checks{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .pill{display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; white-space:nowrap}

  .out{background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:12px; margin:10px 0}
  .section{margin:6px 0 8px}
  .section h3{font-family:"Dancing Script",cursive; font-size:1.25rem; color:#7a5ab0; margin:4px 0}
  .tags{display:flex; flex-wrap:wrap; gap:6px; margin-top:4px}
  .tag{display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:.93rem}
  .ok{color:#167f5d} .muted{color:var(--muted)}

  .actions{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 2px}
  .btn{border:1px solid var(--accent); background:var(--accent); color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-size:0.95rem}
  .btn.secondary{background:#fff; color:#7a5ab0}
  .btn.ghost{background:#fff; color:#5a3b47; border-color:#eec6dc}

  @media (max-width:640px){
    body{font-size:14px}
    .col{flex:1 1 100%; min-width:100%}
    select{min-width:unset; width:100%}
  }
</style>
</head>
<body>
<div class="frame">
  <div class="wrap">

    <!-- ===== PÈRE ===== -->
    <div class="panel" id="pere">
      <h2>Père</h2>
      <div class="row">
        <div class="col">
          <div class="group">
            <label for="pa_base" class="block">Couleur de base</label>
            <select id="pa_base">
              <option value="seal" selected>Seal</option>
              <option value="blue">Blue</option>
              <option value="chocolat">Chocolate</option>
              <option value="lilac">Lilac</option>
              <option value="cinnamon">Cinnamon</option>
              <option value="fawn">Fawn</option>
              <option value="red">Red</option>
              <option value="cream">Cream</option>
            </select>
          </div>
        </div>
        <div class="col">
          <div class="group">
            <label class="block">Porteurs (récessifs)</label>
            <div class="checks">
              <label class="pill"><input type="checkbox" class="pa-choco-port"> Chocolate (B b)</label>
              <label class="pill"><input type="checkbox" class="pa-cinn-port"> Cinnamon (B bl)</label>
              <label class="pill"><input type="checkbox" class="pa-dil-port"> Dilution (D d)</label>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="group">
            <label for="pa_tabby" class="block">Tabby (lynx)</label>
            <select id="pa_tabby">
              <option value="non" selected>Non</option>
              <option value="oui">Oui</option>
              <option value="oui_porteur_non_tabby">Oui porteur non tabby</option>
            </select>
          </div>
        </div>
        <div class="col">
          <div class="group">
            <label for="pa_motif" class="block">Patron</label>
            <select id="pa_motif">
              <option value="" selected>— Sélectionner —</option>
              <option value="colourpoint">Colourpoint</option>
              <option value="mitted">Mitted</option>
              <option value="high_mitted">High Mitted</option>
              <option value="bicolore">Bicolore</option>
              <option value="mid_high_white">Mid High White</option>
              <option value="van_high_white">Van / High White</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== MÈRE ===== -->
    <div class="panel" id="mere">
      <h2>Mère</h2>
      <div class="row">
        <div class="col">
          <div class="group">
            <label for="pb_base" class="block">Couleur de base</label>
            <select id="pb_base">
              <option value="seal" selected>Seal</option>
              <option value="blue">Blue</option>
              <option value="chocolat">Chocolate</option>
              <option value="lilac">Lilac</option>
              <option value="cinnamon">Cinnamon</option>
              <option value="fawn">Fawn</option>
              <option value="seal_tortie">Seal Tortie</option>
              <option value="blue_tortie">Blue Tortie</option>
              <option value="chocolat_tortie">Chocolate Tortie</option>
              <option value="lilac_tortie">Lilac Tortie</option>
              <option value="cinnamon_tortie">Cinnamon Tortie</option>
              <option value="fawn_tortie">Fawn Tortie</option>
              <option value="red">Red</option>
              <option value="cream">Cream</option>
            </select>
          </div>
        </div>
        <div class="col">
          <div class="group">
            <label class="block">Porteuses (récessifs)</label>
            <div class="checks">
              <label class="pill"><input type="checkbox" class="pb-choco-port"> Chocolate (B b)</label>
              <label class="pill"><input type="checkbox" class="pb-cinn-port"> Cinnamon (B bl)</label>
              <label class="pill"><input type="checkbox" class="pb-dil-port"> Dilution (D d)</label>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="group">
            <label for="pb_tabby" class="block">Tabby (lynx)</label>
            <select id="pb_tabby">
              <option value="non" selected>Non</option>
              <option value="oui">Oui</option>
              <option value="oui_porteur_non_tabby">Oui porteur non tabby</option>
            </select>
          </div>
        </div>
        <div class="col">
          <div class="group">
            <label for="pb_motif" class="block">Patron</label>
            <select id="pb_motif">
              <option value="" selected>— Sélectionner —</option>
              <option value="colourpoint">Colourpoint</option>
              <option value="mitted">Mitted</option>
              <option value="high_mitted">High Mitted</option>
              <option value="bicolore">Bicolore</option>
              <option value="mid_high_white">Mid High White</option>
              <option value="van_high_white">Van / High White</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn" id="btn_calc">Prédire</button>
      <button class="btn secondary" id="btn_reset" type="button">Réinitialiser</button>
      <button class="btn ghost" id="btn_print" type="button">Imprimer</button>
    </div>
    <div id="formError" class="error" style="display:none"></div>

    <!-- Résultats -->
    <div class="out">
      <div class="section" id="r_patron"><h3>Patrons</h3><div class="tags" id="motif"></div></div>
      <div class="section" id="r_couleurs"><h3>Couleurs de base</h3><div class="tags" id="basecolors"></div></div>
      <div class="section" id="r_tabby"><h3>Tabby</h3><div class="tags" id="tabby"></div></div>
      <div class="section" id="r_recessifs"><h3>Récessifs (porteurs)</h3><div class="tags" id="recessifs"></div></div>
      <div class="section" id="r_roux"><h3>Red / Tortie (répartition M/F)</h3><div class="tags" id="roux"></div></div>
    </div>
  </div>
</div>

<script>
/* ===== utilitaires ===== */
function setDisabled(el, disabled){ el.disabled=disabled; el.parentElement.style.opacity=disabled?0.55:1; if(disabled) el.checked=false; }
function renderTags(id, items){ const el=document.getElementById(id); el.innerHTML=(items&&items.length)? items.map(x=>`<span class="tag ${x.cls||''}">${x.txt}</span>`).join(''):'<span class="tag muted">—</span>'; }
function round1(x){ return Math.round(x*10)/10; }

/* ===== cohérence porteurs ===== */
function syncBaseToCarriers(prefix){
  const base=document.getElementById(prefix+'_base').value;
  const choco=document.querySelector('.'+prefix+'-choco-port');
  const cinn =document.querySelector('.'+prefix+'-cinn-port');
  const dil  =document.querySelector('.'+prefix+'-dil-port');
  [choco,cinn,dil].forEach(el=>setDisabled(el,false));

  const isDiluted = v=>['blue','lilac','fawn','cream','blue_tortie','lilac_tortie','fawn_tortie'].includes(v);
  const isChocoPh = v=>['chocolat','chocolat_tortie','lilac','lilac_tortie'].includes(v);
  const isCinnaEx = v=>['cinnamon','cinnamon_tortie','fawn','fawn_tortie'].includes(v);

  if(isDiluted(base)) setDisabled(dil,true);
  if(isCinnaEx(base)){ setDisabled(cinn,true); setDisabled(choco,true); return; }
  if(isChocoPh(base)) setDisabled(choco,true);
}
function lockExclusiveCarriers(prefix){
  const ch=document.querySelector('.'+prefix+'-choco-port');
  const ci=document.querySelector('.'+prefix+'-cinn-port');
  if(!ch||!ci) return;
  ch.addEventListener('change',()=>{ if(ch.checked) ci.checked=false; });
  ci.addEventListener('change',()=>{ if(ci.checked) ch.checked=false; });
}
['pa','pb'].forEach(p=>{ document.getElementById(p+'_base').addEventListener('change',()=>syncBaseToCarriers(p)); syncBaseToCarriers(p); lockExclusiveCarriers(p); });

/* ===== patrons (table officielle) ===== */
const P={COLOURPOINT:'colourpoint', MITTED:'mitted', HIGH_MITTED:'high_mitted', BICOLORE:'bicolore', MID_HIGH_WHITE:'mid_high_white', VAN:'van_high_white'};
const motifRuleMap={
  [`${P.COLOURPOINT}|${P.COLOURPOINT}`]: {'Colourpoint':100},
  [`${P.COLOURPOINT}|${P.MITTED}`]: {'Mitted':50,'Colourpoint':50},
  [`${P.COLOURPOINT}|${P.HIGH_MITTED}`]: {'Mitted':100},
  [`${P.COLOURPOINT}|${P.BICOLORE}`]: {'Colourpoint':50,'Bicolore':50},
  [`${P.COLOURPOINT}|${P.MID_HIGH_WHITE}`]: {'Bicolore':50,'Mitted':50},
  [`${P.COLOURPOINT}|${P.VAN}`]: {'Bicolore':100},

  [`${P.MITTED}|${P.COLOURPOINT}`]: {'Colourpoint':50,'Mitted':50},
  [`${P.MITTED}|${P.MITTED}`]: {'Mitted':50,'Colourpoint':25,'High Mitted':25},
  [`${P.MITTED}|${P.HIGH_MITTED}`]: {'Mitted':50,'High Mitted':50},
  [`${P.MITTED}|${P.BICOLORE}`]: {'Colourpoint':25,'Mitted':25,'Bicolore':25,'Mid High White':25},
  [`${P.MITTED}|${P.MID_HIGH_WHITE}`]: {'Mitted':25,'Bicolore':25,'High Mitted':25,'Mid High White':25},
  [`${P.MITTED}|${P.VAN}`]: {'Bicolore':50,'Mid High White':50},

  [`${P.HIGH_MITTED}|${P.COLOURPOINT}`]: {'Mitted':100},
  [`${P.HIGH_MITTED}|${P.MITTED}`]: {'Mitted':50,'High Mitted':50},
  [`${P.HIGH_MITTED}|${P.HIGH_MITTED}`]: {'High Mitted':100},
  [`${P.HIGH_MITTED}|${P.BICOLORE}`]: {'Mitted':50,'Mid High White':50},
  [`${P.HIGH_MITTED}|${P.MID_HIGH_WHITE}`]: {'High Mitted':50,'Mid High White':50},
  [`${P.HIGH_MITTED}|${P.VAN}`]: {'Mid High White':100},

  [`${P.BICOLORE}|${P.COLOURPOINT}`]: {'Colourpoint':50,'Bicolore':50},
  [`${P.BICOLORE}|${P.MITTED}`]: {'Colourpoint':25,'Mitted':25,'Bicolore':25,'Mid High White':25},
  [`${P.BICOLORE}|${P.HIGH_MITTED}`]: {'Mitted':50,'Mid High White':50},
  [`${P.BICOLORE}|${P.BICOLORE}`]: {'Colourpoint':25,'Bicolore':50,'Van/High White':25},
  [`${P.BICOLORE}|${P.MID_HIGH_WHITE}`]: {'Mitted':25,'Bicolore':25,'High Mitted':25,'Van/High White':25},
  [`${P.BICOLORE}|${P.VAN}`]: {'Bicolore':50,'Van/High White':50},

  [`${P.MID_HIGH_WHITE}|${P.COLOURPOINT}`]: {'Bicolore':50,'Mitted':50},
  [`${P.MID_HIGH_WHITE}|${P.MITTED}`]: {'Mitted':25,'Bicolore':25,'High Mitted':25,'Mid High White':25},
  [`${P.MID_HIGH_WHITE}|${P.HIGH_MITTED}`]: {'High Mitted':50,'Mid High White':50},
  [`${P.MID_HIGH_WHITE}|${P.BICOLORE}`]: {'Mitted':25,'Bicolore':25,'High Mitted':25,'Van/High White':25},
  [`${P.MID_HIGH_WHITE}|${P.MID_HIGH_WHITE}`]: {'High Mitted':50,'Mid High White':50},
  [`${P.MID_HIGH_WHITE}|${P.VAN}`]: {'Mid High White':50,'Van/High White':50},

  [`${P.VAN}|${P.COLOURPOINT}`]: {'Bicolore':100},
  [`${P.VAN}|${P.MITTED}`]: {'Mitted':50,'Mid High White':50},
  [`${P.VAN}|${P.HIGH_MITTED}`]: {'Mid High White':100},
  [`${P.VAN}|${P.BICOLORE}`]: {'Bicolore':50,'Van/High White':50},
  [`${P.VAN}|${P.MID_HIGH_WHITE}`]: {'Mid High White':50,'Van/High White':50},
  [`${P.VAN}|${P.VAN}`]: {'Van/High White':100}
};
function computeMotif(pa,pb){ const k=`${pa}|${pb}`, r=`${pb}|${pa}`; return motifRuleMap[k]||motifRuleMap[r]||null; }

/* ===== couleurs (B/D) ===== */
function baseToBDGenotype(base){
  const map={
    seal:{B:['B','B'],D:['D','D']},
    blue:{B:['B','B'],D:['d','d']},
    chocolat:{B:['b','b'],D:['D','D']},
    lilac:{B:['b','b'],D:['d','d']},
    cinnamon:{B:['bl','bl'],D:['D','D']},
    fawn:{B:['bl','bl'],D:['d','d']},

    seal_tortie:{B:['B','B'],D:['D','D']},
    blue_tortie:{B:['B','B'],D:['d','d']},
    chocolat_tortie:{B:['b','b'],D:['D','D']},
    lilac_tortie:{B:['b','b'],D:['d','d']},
    cinnamon_tortie:{B:['bl','bl'],D:['D','D']},
    fawn_tortie:{B:['bl','bl'],D:['d','d']},

    red:{B:['B','B'],D:['D','D']},
    cream:{B:['B','B'],D:['d','d']},
  };
  return map[base]||map.seal;
}
function carriersFromUI(prefix){
  return {
    choco: document.querySelector('.'+prefix+'-choco-port').checked,
    cinn:  document.querySelector('.'+prefix+'-cinn-port').checked,
    dil:   document.querySelector('.'+prefix+'-dil-port').checked
  };
}
function gametes(a1,a2){ return a1===a2?[[a1,1]]:[[a1,.5],[a2,.5]]; }
function cross(gA,gB){
  const m=new Map();
  gA.forEach(([a,pA])=>gB.forEach(([b,pB])=>{
    const k=[a,b].sort().join('/'); m.set(k,(m.get(k)||0)+pA*pB);
  }));
  return [...m.entries()].map(([k,p])=>[[...k.split('/')],p]);
}
function phenotypeB(alleles){
  const set=new Set(alleles);
  if(set.has('B')) return 'Seal';
  if(set.has('b') && set.has('bl')) return 'Chocolate';
  if(alleles[0]==='b' && alleles[1]==='b') return 'Chocolate';
  return 'Cinnamon';
}
function applyDilution(base, d){
  const dd=(d[0]==='d' && d[1]==='d');
  if(!dd) return base;
  if(base==='Seal') return 'Blue';
  if(base==='Chocolate') return 'Lilac';
  if(base==='Cinnamon') return 'Fawn';
  return base;
}
/* injection porteurs (inclut chocolate b/b -> b/bl si 'cinn' coché) */
function injectB(B,car){ let [x,y]=B;
  if(car.choco){ if(x==='B'&&y==='B') y='b'; }
  if(car.cinn){ if(x==='B'&&y==='B') y='bl'; else if(x==='b'&&y==='b') y='bl'; }
  return [x,y];
}
function injectD(D,car){ let [x,y]=D; if(x==='D'&&y==='D'&&car.dil) y='d'; return [x,y]; }

function computeBaseColors(){
  const pa_base=document.getElementById('pa_base').value;
  const pb_base=document.getElementById('pb_base').value;
  const gA=baseToBDGenotype(pa_base), gB=baseToBDGenotype(pb_base);
  const ca=carriersFromUI('pa'), cb=carriersFromUI('pb');
  const BA=injectB(gA.B,ca), DA=injectD(gA.D,ca);
  const BB=injectB(gB.B,cb), DB=injectD(gB.D,cb);
  const kidsB=cross(gametes(BA[0],BA[1]), gametes(BB[0],BB[1]));
  const kidsD=cross(gametes(DA[0],DA[1]), gametes(DB[0],DB[1]));
  const tally=new Map();
  kidsB.forEach(([b,pB])=>kidsD.forEach(([d,pD])=>{
    const base=phenotypeB(b); const col=applyDilution(base,d);
    tally.set(col,(tally.get(col)||0)+pB*pD);
  }));
  return [...tally.entries()].map(([c,p])=>({color:c,prob:round1(p*100)})).sort((a,b)=>b.prob-a.prob);
}
/* probabilité dd globale (pour Red->Cream) */
function ddPercent(){
  const pa_base=document.getElementById('pa_base').value;
  const pb_base=document.getElementById('pb_base').value;
  const gA=baseToBDGenotype(pa_base), gB=baseToBDGenotype(pb_base);
  const ca=carriersFromUI('pa'), cb=carriersFromUI('pb');
  const DA=injectD(gA.D,ca), DB=injectD(gB.D,cb);
  const kidsD=cross(gametes(DA[0],DA[1]), gametes(DB[0],DB[1]));
  let p=0; kidsD.forEach(([d,w])=>{ if(d[0]==='d'&&d[1]==='d') p+=w; });
  return round1(p*100);
}

/* ===== Tabby ===== */
function computeTabby(paTabby,pbTabby){
  const geno=v=>v==='non'?'aa':(v==='oui'?'TT':'Ta');
  const gA=geno(paTabby), gB=geno(pbTabby), out=[];
  if(gA==='aa'&&gB==='aa') out.push({txt:'100% non tabby.',cls:'muted'});
  else if((gA==='TT'&&gB==='aa')||(gA==='aa'&&gB==='TT')) out.push({txt:'100% tabby.',cls:'ok'});
  else if((gA==='Ta'&&gB==='aa')||(gA==='aa'&&gB==='Ta')) out.push({txt:'≈ 50% tabby / 50% non tabby.'});
  else if((gA==='TT'&&gB==='Ta')||(gA==='Ta'&&gB==='TT')) out.push({txt:'100% tabby (≥ hétérozygotes).',cls:'ok'});
  else if(gA==='TT'&&gB==='TT') out.push({txt:'100% tabby (homozygotes).',cls:'ok'});
  else if(gA==='Ta'&&gB==='Ta') out.push({txt:'≈ 75% tabby / 25% non tabby.'});
  return out;
}

/* ===== Récessifs (porteurs seulement) ===== */
// a = parent A porteur ?, b = parent B porteur ?
function carriersOutcome(a, b, nom){
  // Cas spécial Dilution : Dd × Dd => 25% dd / 50% Dd / 25% DD
  if(nom === 'Dilution' && a && b){
    return [{ txt: 'Dilution : ≈ 25% dilués / 50% porteurs / 25% non porteurs.' }];
  }
  // Cas général : si au moins un parent porteur
  if(a || b){
    return [{ txt: `${nom} : ≈ 50% porteurs / 50% non porteurs.` }];
  }
  // Sinon on n'affiche rien
  return [];
}

/* ===== Gène O : Red/Cream & Torties (split par dd) ===== */
function maleOState(){ const b=document.getElementById('pa_base').value; return (b==='red'||b==='cream') ? 'O' : 'o'; }
function femaleOState(){
  const b=document.getElementById('pb_base').value;
  if(b.endsWith('_tortie')) return 'Oo';
  if(b==='red' || b==='cream') return 'OO';
  return 'oo';
}
function splitRed(totalRed, pdd){
  const cream = round1(totalRed * pdd / 100);
  const red   = round1(totalRed - cream);
  if(totalRed===0) return '0% Red';
  if(cream===0)    return `${red}% Red`;
  if(red===0)      return `${cream}% Cream`;
  return `${red}% Red / ${cream}% Cream`;
}
function splitTortie(totalTortie, pdd){
  const creamT = round1(totalTortie * pdd / 100);
  const tortie = round1(totalTortie - creamT);
  if(totalTortie===0) return '0% Torties';
  if(creamT===0)      return `${tortie}% Torties`;
  if(tortie===0)      return `${creamT}% Cream-torties`;
  return `${tortie}% Torties / ${creamT}% Cream-torties`;
}

/* --- helper : distribue la part non-roux selon les couleurs de base calculées --- */
function formatNonRedLine(label, nonRedPct){
  const dist = computeBaseColors(); // [{color:'Seal', prob:50}, {color:'Blue', prob:50}, ...]
  if(nonRedPct <= 0.0001) return `${label} : 0%`;
  const parts = dist.map(d => `${round1(d.prob * nonRedPct / 100)}% ${d.color}`)
                    .filter(t => !/^0(\.0)?%/.test(t));
  return `${label} : ${parts.join(' / ')}`;
}

/* --- version corrigée qui affiche aussi les non-roux/non-rousses --- */
function computeRouxExplicitFromBase(){
  const m = maleOState();      // 'O' ou 'o'
  const f = femaleOState();    // 'OO', 'Oo' ou 'oo'
  const pdd = ddPercent();     // % dd global => Red -> Cream

  // Parts brutes (avant dilution) par sexe
  let malesRed=0, femalesRed=0, femalesTortie=0;
  if(m==='O' && f==='oo'){malesRed=100; femalesTortie=100;}
  else if(m==='O' && f==='Oo'){malesRed=100; femalesRed=50; femalesTortie=50;}
  else if(m==='O' && f==='OO'){malesRed=100; femalesRed=100;}
  else if(m==='o' && f==='oo'){malesRed=0;   femalesRed=0;  femalesTortie=0;}
  else if(m==='o' && f==='Oo'){malesRed=50;  femalesTortie=50;}
  else if(m==='o' && f==='OO'){malesRed=100; femalesTortie=100;}

  const mNonRed = round1(100 - malesRed);
  const fNonRed = round1(100 - (femalesRed + femalesTortie));

  const maleLine =
    `${formatNonRedLine('Mâles non-roux', mNonRed)} — Roux : ${splitRed(malesRed, pdd)}`;

  const femaleBits = [];
  femaleBits.push(formatNonRedLine('Femelles non-rousses', fNonRed));
  if(femalesRed>0)    femaleBits.push(`Rousses : ${splitRed(femalesRed, pdd)}`);
  if(femalesTortie>0) femaleBits.push(`Torties : ${splitTortie(femalesTortie, pdd)}`);
  const femaleLine = femaleBits.join(' — ');

  return [{txt:maleLine},{txt:femaleLine}];
}

/* ===== Calcul global ===== */
function onCalculate(){
  const pa=document.getElementById('pa_motif').value;
  const pb=document.getElementById('pb_motif').value;
  const err=document.getElementById('formError');
  if(!pa || !pb){ err.textContent='Sélectionne un patron pour chaque parent.'; err.style.display='block'; }
  else { err.style.display='none'; }

  const dist=(pa&&pb)?computeMotif(pa,pb):null;
  renderTags('motif', dist? Object.entries(dist).map(([k,v])=>({txt:`${k}: ${v}%`})) : []);

  const colors=computeBaseColors();
  renderTags('basecolors', colors.map(c=>({txt:`${c.color}: ${c.prob}%`})) );

  renderTags('tabby', computeTabby(
    document.getElementById('pa_tabby').value,
    document.getElementById('pb_tabby').value
  ));

  const ca=carriersFromUI('pa'), cb=carriersFromUI('pb');
  const rec=[...carriersOutcome(ca.choco,cb.choco,'Chocolate'),
             ...carriersOutcome(ca.cinn, cb.cinn, 'Cinnamon'),
             ...carriersOutcome(ca.dil,  cb.dil,  'Dilution')];
  renderTags('recessifs', rec.filter(Boolean));

  renderTags('roux', computeRouxExplicitFromBase());
}

/* ===== Boutons ===== */
document.getElementById('btn_calc').addEventListener('click', onCalculate);
document.getElementById('btn_reset').addEventListener('click', ()=>{
  document.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked=false; cb.disabled=false; cb.parentElement.style.opacity=1; });
  document.getElementById('pa_base').value='seal'; document.getElementById('pb_base').value='seal';
  document.getElementById('pa_tabby').value='non'; document.getElementById('pb_tabby').value='non';
  document.getElementById('pa_motif').value=''; document.getElementById('pb_motif').value='';
  ['motif','basecolors','tabby','recessifs','roux'].forEach(id=>document.getElementById(id).innerHTML='');
  document.getElementById('formError').style.display='none';
  syncBaseToCarriers('pa'); syncBaseToCarriers('pb');
});
document.getElementById('btn_print').addEventListener('click', ()=>window.print());
onCalculate();
</script>
</body>
</html>
